from flask import Flask, request, render_template_string
import os

app = Flask(__name__)

# Путь для сохранения заявок рядом с app.py
SAVE_DIR = os.path.join(os.path.dirname(__file__), 'zayavki')
os.makedirs(SAVE_DIR, exist_ok=True)  # Создаем папку, если её нет

form_html = """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Заявка</title>
</head>
<body>
    <h1>Отправить заявку</h1>
    <form method="POST" action="/submit">
        <label for="name">Имя:</label>
        <input type="text" id="name" name="name" required><br><br>
        <label for="message">Сообщение:</label>
        <textarea id="message" name="message" required></textarea><br><br>
        <button type="submit">Отправить</button>
    </form>
</body>
</html>
"""

success_html = """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Успех</title>
</head>
<body>
    <h1>Спасибо, {{ name }}!</h1>
    <p>Ваша заявка принята:</p>
    <p>{{ message }}</p>
    <a href="/">Отправить новую заявку</a>
</body>
</html>
"""

@app.route('/')
def index():
    return render_template_string(form_html)

@app.route('/submit', methods=['POST'])
def submit():
    name = request.form.get('name')
    message = request.form.get('message')

    try:
        safe_name = "".join(c for c in name if c.isalnum() or c in (' ', '_')).rstrip()
        filename = os.path.join(SAVE_DIR, f"{safe_name}_{len(os.listdir(SAVE_DIR)) + 1}.txt")
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(f"Имя: {name}\nСообщение: {message}\n")
    except Exception as e:
        return f"Ошибка при сохранении заявки: {e}"

    return render_template_string(success_html, name=name, message=message)

# Тестовый маршрут для проверки работоспособности сервера
@app.route('/ping')
def ping():
    return 'Server is alive!'

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    try:
        print(f"Сервер запускается на http://0.0.0.0:{port}")
        app.run(host='0.0.0.0', port=port, debug=True, use_reloader=False)
    except Exception as e:
        print(f"Ошибка запуска сервера: {e}")
